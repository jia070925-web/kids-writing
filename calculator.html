<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯µè£è¦åŠƒ</title>
    <style>
        :root { --primary: #2c3e50; --accent: #d35400; --bg: #f4f7f6; --border: #e0e0e0; }
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; background-color: var(--bg); color: var(--primary); margin: 0; padding: 20px; font-size: 15px; }
        * { box-sizing: border-box; }

        /* ä¸»ä½ˆå±€ */
        .container { 
            max-width: 1200px; 
            margin: 0 auto;    
            display: flex; 
            flex-wrap: wrap;   
            gap: 20px; 
            align-items: flex-start;
        }
        
        /* å·¦å´ï¼šè¡¨æ ¼å€ */
        .table-section { 
            flex: 1 1 500px; 
            background: white; 
            border-radius: 6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            border: 1px solid #ccc;
            overflow: hidden;
            display: flex; 
            flex-direction: column;
        }

        .table-header { padding: 10px 15px; background: var(--primary); color: white; }
        .table-header h2 { margin: 0; font-size: 1rem; font-weight: normal; }


        .table-scroll { overflow-x: auto; width: 100%; -webkit-overflow-scrolling: touch; }
        
        /* è¡¨æ ¼è¨­å®š */
        table { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 500px; }
        
        /* æ¬„å¯¬å¾®èª¿ */
        col.c-name { width: 24%; }
        col.c-num { width: 19%; }

        th { font-size: 0.85rem; padding: 6px; background: #f8f9fa; border-bottom: 2px solid #ddd; color: #555; vertical-align: middle; }
        td { padding: 4px; border-bottom: 1px solid #eee; text-align: center; height: 36px; }
        

        tbody tr:nth-child(even) { background-color: #fcfcfc; }

        /* è¼¸å…¥æ¡† */
        input[type="number"] { width: 90%; padding: 4px; border: 1px solid #ccc; border-radius: 3px; text-align: center; font-size: 0.9rem; }
        input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 2px rgba(211,84,0,0.1); }
        
        .bg-inv { background-color: #e8f6f3; color: #16a085; }
        .bg-target { background-color: #ebf5fb; color: #2980b9; }
        input.inp-inv { background-color: #f0fdfa; color: #16a085; font-weight: bold; }
        input.inp-target { background-color: #f4faff; color: #2980b9; font-weight: bold; }

/* å³å´ï¼šçµæœé¢æ¿ */
.result-section { 
    flex: 1 1 300px; 
    background: white; 
    padding: 15px;   
    border-radius: 6px; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
    border-top: 4px solid var(--accent); 
    position: sticky;
    top: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    max-height: 95vh;
    min-width: 0;    
}
        
        .res-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 5px;
        }

        .btn-calc { 
            width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 6px; 
            font-size: 1.1rem; cursor: pointer; font-weight: bold; box-shadow: 0 3px 6px rgba(0,0,0,0.15); 
            transition: 0.2s;
        }
        .btn-calc:hover { background: #ba4a00; transform: translateY(-1px); }
        
        /* æ¸…é™¤æŒ‰éˆ• */
        .btn-reset { 
            background: transparent; 
            color: #999; 
            border: 1px solid #ddd; 
            font-size: 0.8rem; 
            padding: 4px 10px; 
            border-radius: 4px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-reset:hover { background: #f8f8f8; color: #c0392b; border-color: #c0392b; }


/* çµæœè¡¨æ ¼  */
.res-table { 
    width: 100%; 
    font-size: 0.85rem;  
    border-collapse: collapse; 
    table-layout: fixed;  
    min-width: 0; 
}
.res-table th { 
    text-align: left; 
    padding: 6px 4px;    
    border-bottom: 2px solid #ddd; 
    background: #fafafa; 
    color: #555; 
    white-space: nowrap;  
}

.res-table td { 
    padding: 6px 4px;   
    border-bottom: 1px solid #eee; 
    vertical-align: top; 
    

    word-wrap: break-word;     
    overflow-wrap: break-word; 
    word-break: break-all;  
}  
        .sub-text { font-size: 0.85rem; color: #666; margin-top: 2px; display: block; }
        .status-ok { color: #27ae60; }
        .status-bad { color: #c0392b; font-weight: bold; }

        /* æµç¨‹æ—¥èªŒå€å¡Š */
        .log-box {
            flex-grow: 1;
            border: 1px solid #eee;
            background: #fafafa;
            border-radius: 4px;
            padding: 15px;
            overflow-y: auto;
            min-height: 300px;
        }
        .log-list { list-style: none; padding: 0; margin: 0; font-size: 0.9rem; }
        .log-list li { margin-bottom: 15px; border-left: 3px solid #ddd; padding-left: 12px; line-height: 1.6; }
        .log-list li.keep { border-left-color: #27ae60; }
        .log-list li.temp { border-left-color: #f39c12; }
        
        .step-header { font-weight: bold; color: #333; margin-bottom: 4px; display: block; }
        .step-detail { color: #555; font-family: Consolas, Monaco, monospace; font-size: 0.85rem; background: #fff; padding: 6px 10px; border: 1px solid #eee; border-radius: 3px; display: block; margin-top: 4px; }

        /* æ‰‹æ©Ÿç‰ˆé©é… */
        @media (max-width: 900px) {
            .result-section { 
                position: static; 
                width: 100%; 
                max-height: none; 
                flex: none;
            }
            .log-box {
                max-height: 500px; 
            }
        }

        /* è¨­å®šçµæœè¡¨æ ¼æ¬„ä½å¯¬åº¦æ¯”ä¾‹ */
.res-table th:nth-child(1) { width: 20%; } /* é …ç›® */
.res-table th:nth-child(2) { width: 28%; } /* å³°å€¼éœ€æ±‚ */
.res-table th:nth-child(3) { width: 28%; } /* åº«å­˜ */
.res-table th:nth-child(4) { width: 24%; } /* ç‹€æ…‹ (çµ¦äºˆè¶³å¤ ç©ºé–“é¡¯ç¤º "ç¼ºxxx") */

/* --- å›ºå®šç¬¬ä¸€æ¬„ (å‡çµè¦–çª—æ•ˆæœ - ä¿®æ­£ç‰ˆ) --- */
    
    /* 1. è¨­å®šç¬¬ä¸€æ¬„ (åç¨±) ç‚ºé»æ€§å®šä½ */
    table td:first-child, 
    table th:first-child {
        position: sticky;
        left: 0;
        z-index: 10;
        border-right: 1px solid #ddd;
    }

    /* 2. å·¦ä¸Šè§’æ¨™é¡Œæ ¼ */
    thead tr:first-child th:first-child {
        z-index: 20; 
        background-color: #f8f9fa; 
        color: #555; 
    }

    /* 3. è¨­å®šå…§å®¹åˆ—ç¬¬ä¸€æ¬„çš„èƒŒæ™¯è‰² */
    tbody tr td:first-child {
        background-color: #fff; 
    }
    
    /* 4. ä¿®æ­£å¶æ•¸è¡Œçš„èƒŒæ™¯è‰² */
    tbody tr:nth-child(even) td:first-child {
        background-color: #fcfcfc; 
    }

    /* 5. ä¿®æ­£æ‰‹æ©Ÿç‰ˆæ²å‹•æ™‚çš„é‚Šè· */
    .table-scroll {
        overflow-x: auto;
        padding-left: 0; 
    }
    </style>
</head>
<body>

<div class="container">
    <div class="table-section">
        <div class="table-header">
            <h2>å¯µå‚™è¦åŠƒ</h2>
        </div>
        <div class="table-scroll">
            <table>
                <colgroup>
                    <col class="c-name">
                    <col class="c-num">
                    <col class="c-num">
                    <col class="c-num">
                    <col class="c-num">
                </colgroup>
                <thead>
                    <tr>
                        <th rowspan="2" style="text-align:center; padding-left:15px;">åç¨±</th>
                        <th colspan="2" class="bg-inv">ç›®å‰è£å‚™(å¯åˆ†è§£)</th>
                        <th colspan="2" class="bg-target">è£½ä½œç›®æ¨™</th>
                    </tr>
                    <tr>
                        <th class="bg-inv">çœŸè£</th>
                        <th class="bg-inv">ä»¿è£</th>
                        <th class="bg-target">çœŸè£</th>
                        <th class="bg-target">ä»¿è£</th>
                    </tr>
                </thead>
                <tbody id="tableRoot"></tbody>
            </table>
        </div>
    </div>

    <div class="result-section">
        <div class="res-header">
            <h3 style="margin:0; font-size:1.1rem;">è¨ˆç®—çµæœ</h3>
            <button class="btn-reset" onclick="resetAll()">ğŸ—‘ï¸ æ¸…é™¤</button>
        </div>

        <button class="btn-calc" onclick="calculate()">âŸ³ è¨ˆç®—éœ€æ±‚</button>
        
        <div>
            <h4 style="margin: 0 0 10px 0; font-size: 0.95rem; color:#666;">ææ–™çµ±è¨ˆ</h4>
            <table class="res-table">
                <thead>
                    <tr>
                        <th width="20%" style="text-align:center">é …ç›®</th>
                        <th width="30%" style="text-align:center">å³°å€¼éœ€æ±‚</th>
                        <th width="25%" style="text-align:center">åº«å­˜</th>
                        <th width="25%" style="text-align:center">ç‹€æ…‹</th>
                    </tr>
                </thead>
                <tbody id="res_tbody">
                    <tr><td colspan="4" style="text-align:center; color:#999; padding:20px;">å°šç„¡æ•¸æ“š</td></tr>
                </tbody>
            </table>
        </div>

        <div style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
            <h4 style="margin: 0 0 10px 0; font-size: 0.95rem; color:#666;">å»ºè­°æµç¨‹</h4>
            <div class="log-box">
                <ul id="step_summary" class="log-list"></ul>
            </div>
        </div>
    </div>
</div>

<script>
    // --- æ•¸æ“šåº« ---
    const db = [

        {name:"éŠ…1", t:{p:5620, c:778000, m:{'éŠ…':4}}, i:{p:600}},
        {name:"éŠ…2", t:{p:6320, c:803000, m:{'éŠ…':10}}, i:{p:700}},
        {name:"éŠ…3", t:{p:7120, c:833000, m:{'éŠ…':18}}, i:{p:800}},
        {name:"éµ1", t:{p:8120, c:863000, m:{'éŠ…':18,'éµ':4}}, i:{p:1000}},
        {name:"éµ2", t:{p:9220, c:898000, m:{'éŠ…':18,'éµ':10}}, i:{p:1100}},
        {name:"éµ3", t:{p:10420, c:938000, m:{'éŠ…':18,'éµ':18}}, i:{p:1200}},
        {name:"çŠç‘š1", t:{p:11820, c:978000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':4}}, i:{p:1400}},
        {name:"çŠç‘š2", t:{p:13320, c:1028000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':10}}, i:{p:1500}},
        {name:"çŠç‘š3", t:{p:14920, c:1188000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18}}, i:{p:1600}},
        {name:"æ£±æ™¶1", t:{p:18920, c:1238000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18,'æ£±æ™¶':10}}, i:{p:4000}},
        {name:"æ£±æ™¶2", t:{p:23920, c:1438000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18,'æ£±æ™¶':25}}, i:{p:5000}},
        {name:"æ£±æ™¶3", t:{p:29920, c:1688000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18,'æ£±æ™¶':45}}, i:{p:6000}},
        {name:"æ©Ÿæ¢°1", t:{p:32920, c:1838000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18,'æ£±æ™¶':45,'æŒ¯é‡‘':10}}, i:{p:6600}},
        {name:"æ©Ÿæ¢°2", t:{p:26920, c:2038000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18,'æ£±æ™¶':45,'æŒ¯é‡‘':25}}, i:{p:7200}},
        {name:"æ©Ÿæ¢°3", t:{p:41920, c:2288000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18,'æ£±æ™¶':45,'æŒ¯é‡‘':45}}, i:{p:8000}},
        {name:"ç¥æº1", t:{p:32920, c:2588000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18,'æ£±æ™¶':45,'æŒ¯é‡‘':45,'ç¥æºçŸ³':10}}, i:{p:6600}},
        {name:"ç¥æº2", t:{p:40920, c:2638000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18,'æ£±æ™¶':45,'æŒ¯é‡‘':45,'ç¥æºçŸ³':25}}, i:{p:7200}},
        {name:"ç¥æº3", t:{p:53920, c:2888000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18,'æ£±æ™¶':45,'æŒ¯é‡‘':45,'ç¥æºçŸ³':45}}, i:{p:8000}}
    ];

    const POINTS_PER_BOX = 5;
    const BOXES_PER_OPEN = 2; 
    const matKeys = ['points', 'è²¢ç»', 'éŠ…', 'éµ', 'çŠç‘š', 'æ£±æ™¶', 'æŒ¯é‡‘', 'ç¥æºçŸ³'];
    
    // åˆå§‹åŒ–ï¼šç§»é™¤åŸæœ¬çš„åˆ†çµ„é‚è¼¯ï¼Œç›´æ¥ç”Ÿæˆæ‰€æœ‰åˆ—
window.onload = function() {
        const tableRoot = document.getElementById('tableRoot');
        tableRoot.innerHTML = ''; // æ¸…ç©º

        db.forEach((item, i) => {
            const tr = document.createElement('tr');
            // â–¼â–¼â–¼ ä¿®æ”¹è™•ï¼šæ¯å€‹ input éƒ½åŠ å…¥äº†é™åˆ¶èªæ³• â–¼â–¼â–¼
            tr.innerHTML = `
                <td style="text-align:center; padding-left:15px; font-weight:500;">${item.name}</td>
                <td><input type="number" min="0" oninput="if(value<0)value=0" id="inv_true_${i}" class="inp-inv" placeholder="-"></td>
                <td><input type="number" min="0" oninput="if(value<0)value=0" id="inv_imit_${i}" class="inp-inv" placeholder="-"></td>
                <td><input type="number" min="0" oninput="if(value<0)value=0" id="targ_true_${i}" class="inp-target" placeholder="-"></td>
                <td><input type="number" min="0" oninput="if(value<0)value=0" id="targ_imit_${i}" class="inp-target" placeholder="-"></td>
            `;
            tableRoot.appendChild(tr);
        });

        // ç¶å®š Enter éµè¨ˆç®—
        document.addEventListener('keydown', e => { if(e.key==='Enter') calculate(); });
    };


    function resetAll() {
        document.querySelectorAll('input').forEach(i => i.value = '');
        calculate();
    }

    function calculate() {
        let inventory = {};
        matKeys.forEach(k => inventory[k] = 0);
        let targets = [];

        db.forEach((item, idx) => {
            let invTrue = parseInt(document.getElementById(`inv_true_${idx}`).value) || 0;
            let invImit = parseInt(document.getElementById(`inv_imit_${idx}`).value) || 0;
            let targTrue = parseInt(document.getElementById(`targ_true_${idx}`).value) || 0;
            let targImit = parseInt(document.getElementById(`targ_imit_${idx}`).value) || 0;

            if (invTrue > 0) {
                inventory.points += (item.t.p * invTrue);
                inventory['è²¢ç»'] += ((item.t.c||0) * invTrue);
                if (item.t.m) {
                    for(let k in item.t.m) inventory[k] += (item.t.m[k] * invTrue);
                }
            }
            if (invImit > 0) {
                inventory.points += (item.i.p * invImit);
            }

            if (targTrue > 0 || targImit > 0) {
                targets.push({ data: item, keep: targTrue, imit: targImit });
            }
        });

        let currentUsage = {};
        let maxPeak = {};
        matKeys.forEach(k => { currentUsage[k] = 0; maxPeak[k] = 0; });

        let steps = [];
        let cycleGroup = targets.filter(t => t.keep === 0);
        let keepGroup = targets.filter(t => t.keep > 0);
        cycleGroup.sort((a,b) => b.data.t.p - a.data.t.p);
        keepGroup.sort((a,b) => a.data.t.p - b.data.t.p);
        let order = [...cycleGroup, ...keepGroup];

        if (order.length === 0 && inventory.points === 0) {
            document.getElementById('res_tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999; padding:20px;">å°šç„¡æ•¸æ“š</td></tr>';
            document.getElementById('step_summary').innerHTML = '';
            return;
        }

        order.forEach(t => {
            let item = t.data;
            let isKeep = t.keep > 0;
            let logClass = isKeep ? "keep" : "temp";
            let trueCount = (t.keep > 0) ? t.keep : 1;
            
            let t_op_val = item.t.p / 10; 
            let i_op_val = item.i.p / 10; 
            
            let total_true_op = t_op_val * trueCount;
            let total_imit_op = 0;
            if(t.imit > 0) total_imit_op = i_op_val * t.imit;

            let stepTitle = `${item.name} çœŸx${trueCount}`;
            if(t.imit > 0) stepTitle += ` âœ ä»¿x${t.imit}`;

            let detail = "";
            let sum_val = total_true_op + total_imit_op;
            
            detail += `å–®é‚Šææ–™æ•¸é‡ï¼š${total_true_op.toLocaleString()}(çœŸ) + ${total_imit_op.toLocaleString()}(ä»¿) = ${sum_val.toLocaleString()}<br>`;
            detail += `*${total_true_op.toLocaleString()} = ${item.t.p}/5/2<br>`;
            
            if(t.imit > 0) {
                detail += `*${total_imit_op.toLocaleString()} = ${item.i.p}/5/2*${t.imit}ä»¶<br>`;
            }
            
            if(isKeep) {
                detail += `<span style="color:#27ae60">ä¿ç•™ çœŸx${trueCount}</span>`;
            } else {
                detail += `<span style="color:#f39c12">åˆ†è§£ çœŸx${trueCount}</span>`;
            }

            steps.push(`<li class="${logClass}">
                <span class="step-header">${stepTitle}</span>
                <span class="step-detail">${detail}</span>
            </li>`);

            function addCost(multiplier) {
                currentUsage.points += (item.t.p * multiplier);
                if (currentUsage.points > maxPeak.points) maxPeak.points = currentUsage.points;
                currentUsage['è²¢ç»'] += ((item.t.c||0) * multiplier);
                if (currentUsage['è²¢ç»'] > maxPeak['è²¢ç»']) maxPeak['è²¢ç»'] = currentUsage['è²¢ç»'];

                if(item.t.m) {
                    for(let k in item.t.m) {
                        currentUsage[k] += (item.t.m[k] * multiplier);
                        if(currentUsage[k] > maxPeak[k]) maxPeak[k] = currentUsage[k];
                    }
                }
            }
            addCost(trueCount);

            if (t.imit > 0) {
                let imitCost = t.imit * item.i.p;
                currentUsage.points += imitCost; 
                if (currentUsage.points > maxPeak.points) maxPeak.points = currentUsage.points;
            }

            if (!isKeep) {
                function removeCost(multiplier) {
                    currentUsage.points -= (item.t.p * multiplier);
                    currentUsage['è²¢ç»'] -= ((item.t.c||0) * multiplier);
                    if(item.t.m) {
                        for(let k in item.t.m) currentUsage[k] -= (item.t.m[k] * multiplier);
                    }
                }
                removeCost(trueCount);
            }
        });

        let html = '';
        
        let boxPeak = Math.ceil(maxPeak.points / POINTS_PER_BOX);
        let openPeak = Math.ceil(boxPeak / BOXES_PER_OPEN);
        let boxInv = Math.floor(inventory.points / POINTS_PER_BOX);
        
        let netPoints = maxPeak.points - inventory.points;
        let netBoxes = Math.ceil(Math.max(0, netPoints) / POINTS_PER_BOX);
        let netOpens = Math.ceil(netBoxes / BOXES_PER_OPEN);

        html += `<tr style="background:#fff8e1;">
            <td>æ©˜è‰²ç›’å­</td>
            <td>${boxPeak.toLocaleString()}</td>
            <td>${boxInv.toLocaleString()}</td>
            <td class="${netBoxes>0?'status-bad':'status-ok'}">
                ${netBoxes>0 ? 'ç¼º'+netBoxes.toLocaleString() : 'å……è¶³'}<br>
                ${netBoxes>0 ? '<span class="sub-text"></span>' : ''}
            </td>
        </tr>`;

        let usedMats = matKeys.filter(k => k !== 'points' && maxPeak[k] > 0);
        usedMats.forEach(k => {
            let peak = maxPeak[k];
            let inv = inventory[k];
            let missing = Math.max(0, peak - inv);
            html += `<tr>
                <td>${k}</td>
                <td>${peak.toLocaleString()}</td>
                <td>${inv.toLocaleString()}</td>
                <td class="${missing>0?'status-bad':'status-ok'}">${missing>0 ? 'ç¼º'+missing.toLocaleString() : 'å……è¶³'}</td>
            </tr>`;
        });

        document.getElementById('res_tbody').innerHTML = html;
        document.getElementById('step_summary').innerHTML = steps.join('');
    }
</script>

</body>
</html>