<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è£å‚™è£½ä½œè¦åŠƒè¡¨ (æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ)</title>
    <style>
        :root { --primary: #2c3e50; --accent: #d35400; --bg: #f4f7f6; --border: #e0e0e0; }
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; background-color: var(--bg); color: var(--primary); margin: 0; padding: 20px; font-size: 15px; }
        * { box-sizing: border-box; }

        .container { 
            max-width: 1200px; 
            margin: 0 auto;    
            display: flex; 
            flex-wrap: wrap;   
            gap: 20px; 
            align-items: flex-start;
        }
        
        /* --- è¡¨æ ¼å€å¡Šå„ªåŒ– --- */
        .table-section { 
            flex: 1 1 500px; 
            background: white; 
            border-radius: 6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            border: 1px solid #ccc;
            overflow: hidden;
            display: flex; 
            flex-direction: column;
        }

        .table-header { padding: 10px 15px; background: var(--primary); color: white; }
        .table-header h2 { margin: 0; font-size: 1rem; font-weight: normal; }

        /* é—œéµï¼šå¤–å±¤å®¹å™¨å…è¨±æ»¾å‹• */
        .table-scroll { 
            overflow: auto; 
            max-height: 80vh; /* é™åˆ¶é«˜åº¦ï¼Œè§¸ç™¼å‚ç›´å›ºå®šè¡¨é ­ */
            width: 100%; 
            -webkit-overflow-scrolling: touch; 
        }

        table { width: 100%; border-collapse: separate; border-spacing: 0; table-layout: fixed; min-width: 550px; }
        
        col.c-name { width: 110px; } /* å›ºå®šåç¨±æ¬„å¯¬åº¦ */
        col.c-num { width: 110px; }

        /* --- Sticky å›ºå®šæ•ˆæœ --- */
        thead th { 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            background: #f8f9fa; 
            border-bottom: 2px solid #ddd;
        }
        
        /* åç¨±æ¬„å›ºå®šåœ¨å·¦å´ */
        td:first-child, th:first-child {
            position: sticky;
            left: 0;
            z-index: 50;
            background-color: #fff;
            border-right: 2px solid #eee;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }

        /* åˆ†çµ„æ¨™é¡Œå›ºå®š */
        tr.group-row td {
            position: sticky;
            left: 0;
            background-color: #eaeaea !important;
            z-index: 60;
            text-align: left;
            padding: 8px 15px;
        }

        th { font-size: 0.8rem; padding: 8px 4px; color: #555; vertical-align: middle; border-bottom: 1px solid #ddd; }
        td { padding: 4px; border-bottom: 1px solid #eee; text-align: center; height: 42px; background: #fff; }

        .arrow { display: inline-block; transition: transform 0.2s; margin-right: 5px; font-size: 0.8rem; }
        .collapsed .arrow { transform: rotate(-90deg); }
        .tbody-group.hidden { display: none; }

        /* è¼¸å…¥æ¡†å„ªåŒ– */
        input[type="number"] { 
            width: 95%; 
            padding: 8px 2px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            text-align: center; 
            font-size: 1rem; /* é˜²æ­¢ iOS è‡ªå‹•æ”¾å¤§ */
        }
        input:focus { border-color: var(--accent); outline: none; background: #fffdfb; }
        
        .bg-inv { background-color: #e8f6f3; color: #16a085; }
        .bg-target { background-color: #ebf5fb; color: #2980b9; }

        /* --- çµæœé¢æ¿ --- */
        .result-section { 
            flex: 1 1 350px; 
            background: white; 
            padding: 20px; 
            border-radius: 6px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
            border-top: 4px solid var(--accent); 
            position: sticky;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 95vh;
        }
        
        .btn-calc { 
            width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 6px; 
            font-size: 1.1rem; cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .btn-reset { background: transparent; color: #999; border: 1px solid #ddd; padding: 4px 10px; border-radius: 4px; cursor: pointer; }

        .res-table { width: 100%; font-size: 0.9rem; border-collapse: collapse; }
        .res-table th { text-align: left; padding: 8px; border-bottom: 2px solid #ddd; background: #fafafa; }
        .res-table td { padding: 8px; border-bottom: 1px solid #eee; }
        
        .status-ok { color: #27ae60; }
        .status-bad { color: #c0392b; font-weight: bold; }

        .log-box { flex-grow: 1; border: 1px solid #eee; background: #fafafa; border-radius: 4px; padding: 12px; overflow-y: auto; min-height: 250px; }
        .log-list { list-style: none; padding: 0; margin: 0; font-size: 0.85rem; }
        .log-list li { margin-bottom: 10px; border-left: 3px solid #ddd; padding-left: 10px; }

        /* --- æ‰‹æ©Ÿç‰ˆé©é… --- */
        @media (max-width: 900px) {
            body { padding: 10px; }
            .result-section { position: static; width: 100%; max-height: none; }
            .container { gap: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="table-section">
        <div class="table-header">
            <h2>è£å‚™è¦åŠƒè¼¸å…¥ (æ»‘å‹•è¡¨æ ¼æŸ¥çœ‹æ›´å¤š)</h2>
        </div>
        <div class="table-scroll">
            <table>
                <colgroup>
                    <col class="c-name">
                    <col class="c-num">
                    <col class="c-num">
                    <col class="c-num">
                    <col class="c-num">
                </colgroup>
                <thead>
                    <tr>
                        <th rowspan="2" style="text-align:left; padding-left:15px;">åç¨±</th>
                        <th colspan="2" class="bg-inv">åº«å­˜ (å¯åˆ†è§£)</th>
                        <th colspan="2" class="bg-target">è£½ä½œç›®æ¨™</th>
                    </tr>
                    <tr>
                        <th class="bg-inv">çœŸè£</th>
                        <th class="bg-inv">ä»¿è£</th>
                        <th class="bg-target">ä¿ç•™çœŸè£</th>
                        <th class="bg-target">éæ¸¡ä»¿è£</th>
                    </tr>
                </thead>
                <tbody id="mainTable"></tbody>
            </table>
        </div>
    </div>

    <div class="result-section">
        <div class="res-header" style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">ğŸ“Š è¨ˆç®—çµæœ</h3>
            <button class="btn-reset" onclick="resetAll()">ğŸ—‘ï¸ æ¸…é™¤</button>
        </div>

        <button class="btn-calc" onclick="calculate()">âŸ³ é–‹å§‹è¨ˆç®—</button>
        
        <div id="result_area">
            <table class="res-table">
                <thead>
                    <tr>
                        <th width="25%">é …ç›®</th>
                        <th width="35%">éœ€æ±‚</th>
                        <th width="40%">ç‹€æ…‹</th>
                    </tr>
                </thead>
                <tbody id="res_tbody">
                    <tr><td colspan="3" style="text-align:center; color:#999; padding:20px;">å°šç„¡æ•¸æ“š</td></tr>
                </tbody>
            </table>
        </div>

        <div style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
            <h4 style="margin: 10px 0 5px 0; font-size: 0.9rem;">è©³ç´°æµç¨‹</h4>
            <div class="log-box">
                <ul id="step_summary" class="log-list"></ul>
            </div>
        </div>
    </div>
</div>

<script>
    const db = [
        {name:"1", t:{p:10, c:2000}, i:{p:10}}, {name:"2", t:{p:40, c:7000}, i:{p:20}}, {name:"3", t:{p:110, c:18000}, i:{p:30}},
        {name:"4", t:{p:260, c:41000}, i:{p:40}}, {name:"5", t:{p:570, c:88000}, i:{p:50}}, {name:"6", t:{p:1200, c:183000}, i:{p:60}},
        {name:"7", t:{p:2470, c:374000}, i:{p:70}}, {name:"8", t:{p:5020, c:758000}, i:{p:80}},
        {name:"éŠ…1", t:{p:5620, c:778000, m:{'éŠ…':4}}, i:{p:600}}, {name:"éŠ…2", t:{p:6320, c:803000, m:{'éŠ…':10}}, i:{p:700}}, {name:"éŠ…3", t:{p:7120, c:833000, m:{'éŠ…':18}}, i:{p:800}},
        {name:"éµ1", t:{p:8120, c:863000, m:{'éŠ…':18,'éµ':4}}, i:{p:1000}}, {name:"éµ2", t:{p:9220, c:898000, m:{'éŠ…':18,'éµ':10}}, i:{p:1100}}, {name:"éµ3", t:{p:10420, c:938000, m:{'éŠ…':18,'éµ':18}}, i:{p:1200}},
        {name:"çŠç‘š1", t:{p:11820, c:978000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':4}}, i:{p:1400}}, {name:"çŠç‘š2", t:{p:13320, c:1028000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':10}}, i:{p:1500}}, {name:"çŠç‘š3", t:{p:14920, c:1188000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18}}, i:{p:1600}},
        {name:"æ£±æ™¶1", t:{p:18920, c:1238000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18,'æ£±æ™¶':10}}, i:{p:4000}}, {name:"æ£±æ™¶2", t:{p:23920, c:1438000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18,'æ£±æ™¶':25}}, i:{p:5000}}, {name:"æ£±æ™¶3", t:{p:29920, c:1688000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18,'æ£±æ™¶':45}}, i:{p:6000}},
        {name:"æ©Ÿæ¢°1", t:{p:32920, c:1838000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18,'æ£±æ™¶':45,'æŒ¯é‡‘':10}}, i:{p:6600}}, {name:"æ©Ÿæ¢°2", t:{p:26920, c:2038000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18,'æ£±æ™¶':45,'æŒ¯é‡‘':25}}, i:{p:7200}}, {name:"æ©Ÿæ¢°3", t:{p:41920, c:2288000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18,'æ£±æ™¶':45,'æŒ¯é‡‘':45}}, i:{p:8000}},
        {name:"ç¥æº1", t:{p:32920, c:2588000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18,'æ£±æ™¶':45,'æŒ¯é‡‘':45,'ç¥æºçŸ³':10}}, i:{p:6600}}, {name:"ç¥æº2", t:{p:40920, c:2638000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18,'æ£±æ™¶':45,'æŒ¯é‡‘':45,'ç¥æºçŸ³':25}}, i:{p:7200}}, {name:"ç¥æº3", t:{p:53920, c:2888000, m:{'éŠ…':18,'éµ':18,'çŠç‘š':18,'æ£±æ™¶':45,'æŒ¯é‡‘':45,'ç¥æºçŸ³':45}}, i:{p:8000}}
    ];

    const groups = [
        { id: 'g1', title: 'åŸºç¤è£å‚™ (1-8)', start: 0, end: 7, open: false },
        { id: 'g2', title: 'éŠ…éš (éŠ…1-3)', start: 8, end: 10, open: false },
        { id: 'g3', title: 'éµéš (éµ1-3)', start: 11, end: 13, open: false },
        { id: 'g4', title: 'é€²éš (çŠç‘š/æ£±æ™¶/æ©Ÿæ¢°/ç¥æº)', start: 14, end: db.length-1, open: true }
    ];

    window.onload = function() {
        const table = document.querySelector('table');
        groups.forEach(g => {
            const hBody = document.createElement('tbody');
            hBody.innerHTML = `<tr class="group-row ${g.open?'':'collapsed'}"><td colspan="5"><span class="arrow">â–¼</span> ${g.title}</td></tr>`;
            table.appendChild(hBody);

            const cBody = document.createElement('tbody');
            cBody.className = `tbody-group ${g.open?'':'hidden'}`;
            for(let i=g.start; i<=g.end; i++){
                const item = db[i];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="text-align:left; padding-left:15px; font-weight:bold;">${item.name}</td>
                    <td><input type="number" inputmode="decimal" id="inv_true_${i}" class="inp-inv" placeholder="-"></td>
                    <td><input type="number" inputmode="decimal" id="inv_imit_${i}" class="inp-inv" placeholder="-"></td>
                    <td><input type="number" inputmode="decimal" id="targ_true_${i}" class="inp-target" placeholder="-"></td>
                    <td><input type="number" inputmode="decimal" id="targ_imit_${i}" class="inp-target" placeholder="-"></td>
                `;
                cBody.appendChild(tr);
            }
            table.appendChild(cBody);
            hBody.onclick = () => { hBody.firstChild.classList.toggle('collapsed'); cBody.classList.toggle('hidden'); };
        });
    };

    function resetAll() { document.querySelectorAll('input').forEach(i => i.value = ''); calculate(); }

    function calculate() {
        let inventory = { points: 0, 'è²¢ç»': 0, 'éŠ…': 0, 'éµ': 0, 'çŠç‘š': 0, 'æ£±æ™¶': 0, 'æŒ¯é‡‘': 0, 'ç¥æºçŸ³': 0 };
        let targets = [];

        db.forEach((item, idx) => {
            let ivT = parseInt(document.getElementById(`inv_true_${idx}`).value) || 0;
            let ivI = parseInt(document.getElementById(`inv_imit_${idx}`).value) || 0;
            let tgT = parseInt(document.getElementById(`targ_true_${idx}`).value) || 0;
            let tgI = parseInt(document.getElementById(`targ_imit_${idx}`).value) || 0;

            if (ivT > 0) {
                inventory.points += (item.t.p * ivT);
                inventory['è²¢ç»'] += ((item.t.c||0) * ivT);
                if (item.t.m) for(let k in item.t.m) inventory[k] += (item.t.m[k] * ivT);
            }
            if (ivI > 0) inventory.points += (item.i.p * ivI);
            if (tgT > 0 || tgI > 0) targets.push({ data: item, keep: tgT, imit: tgI });
        });

        let currentUsage = { points: 0, 'è²¢ç»': 0, 'éŠ…': 0, 'éµ': 0, 'çŠç‘š': 0, 'æ£±æ™¶': 0, 'æŒ¯é‡‘': 0, 'ç¥æºçŸ³': 0 };
        let maxPeak = { ...currentUsage };
        let steps = [];
        
        // æ’åºï¼šéæ¸¡è£å…ˆåšå®Œæ‹†æ‰ï¼Œæœ€å¾Œæ‰åšè¦ä¿ç•™çš„
        let order = [...targets.filter(t => t.keep === 0).sort((a,b) => b.data.t.p - a.data.t.p), ...targets.filter(t => t.keep > 0).sort((a,b) => a.data.t.p - b.data.t.p)];

        if (order.length === 0 && inventory.points === 0) {
            document.getElementById('res_tbody').innerHTML = '<tr><td colspan="3" style="text-align:center;color:#999;padding:20px;">å°šç„¡æ•¸æ“š</td></tr>';
            document.getElementById('step_summary').innerHTML = '';
            return;
        }

        order.forEach(t => {
            let item = t.data;
            let count = (t.keep > 0) ? t.keep : 1;
            let isKeep = t.keep > 0;

            steps.push(`<li class="${isKeep?'keep':'temp'}"><strong>${item.name} çœŸx${count}${t.imit>0?' + ä»¿x'+t.imit:''}</strong><br><small>${isKeep?'ä¿ç•™è£å‚™':'éæ¸¡åˆ†è§£'}</small></li>`);

            const add = (m) => {
                currentUsage.points += (item.t.p * m);
                currentUsage['è²¢ç»'] += ((item.t.c||0) * m);
                if(item.t.m) for(let k in item.t.m) currentUsage[k] += (item.t.m[k] * m);
                for(let k in currentUsage) if(currentUsage[k] > maxPeak[k]) maxPeak[k] = currentUsage[k];
            };
            
            add(count);
            if(t.imit > 0) {
                currentUsage.points += (item.i.p * t.imit);
                if(currentUsage.points > maxPeak.points) maxPeak.points = currentUsage.points;
            }
            if(!isKeep) {
                currentUsage.points -= (item.t.p * count);
                currentUsage['è²¢ç»'] -= ((item.t.c||0) * count);
                if(item.t.m) for(let k in item.t.m) currentUsage[k] -= (item.t.m[k] * count);
            }
        });

        let html = '';
        let netBoxes = Math.ceil(Math.max(0, maxPeak.points - inventory.points) / 5);
        html += `<tr style="background:#fff8e1;"><td>æ©˜è‰²ç›’å­</td><td>${Math.ceil(maxPeak.points/5).toLocaleString()}</td><td class="${netBoxes>0?'status-bad':'status-ok'}">${netBoxes>0?'ç¼º'+netBoxes:'å……è¶³'}${netBoxes>0?'<br>(é–‹'+Math.ceil(netBoxes/2)+'çµ„)':''}</td></tr>`;
        
        ['è²¢ç»','éŠ…','éµ','çŠç‘š','æ£±æ™¶','æŒ¯é‡‘','ç¥æºçŸ³'].forEach(k => {
            if(maxPeak[k] > 0) {
                let miss = Math.max(0, maxPeak[k] - inventory[k]);
                html += `<tr><td>${k}</td><td>${maxPeak[k].toLocaleString()}</td><td class="${miss>0?'status-bad':'status-ok'}">${miss>0?'ç¼º'+miss.toLocaleString():'å……è¶³'}</td></tr>`;
            }
        });

        document.getElementById('res_tbody').innerHTML = html;
        document.getElementById('step_summary').innerHTML = steps.join('');
    }
</script>
</body>
</html>