<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>直式生字練習簿</title>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <style>
        /* --- 基礎設定 --- */
        body { 
            font-family: "標楷體", "KaiTi", serif; 
            margin: 0; padding: 20px; 
            background-color: #555; 
            display: flex; flex-direction: column; align-items: center;
        }

        /* --- 控制面板 --- */
        .controls { 
            background: white; padding: 20px; border-radius: 8px; 
            margin-bottom: 20px; text-align: center; width: 100%; max-width: 800px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .control-group { margin: 15px 0; display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; }
        
        input[type="text"] { padding: 8px; font-size: 1.5rem; width: 80px; text-align: center; border: 2px solid #4CAF50; border-radius: 5px;}
        
        /* 滑桿樣式優化 */
        input[type="range"] {
            -webkit-appearance: none;
            width: 250px;
            height: 10px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            transition: .2s;
            cursor: pointer;
            vertical-align: middle;
        }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }

        button { 
            padding: 10px 25px; font-size: 1.1rem; cursor: pointer; 
            background-color: #4CAF50; color: white; border: none; border-radius: 4px;
            font-weight: bold;
        }
        button:hover { background-color: #45a049; }
        button.print-btn { background-color: #2196F3; }
        button.print-btn:hover { background-color: #0b7dda; }

        /* --- A4 紙張模擬 --- */
        .page {
            width: 210mm; 
            height: 296mm; 
            background: white;
            padding: 15mm; 
            box-sizing: border-box;
            display: flex;
            flex-direction: row-reverse; 
            gap: 5mm;
            overflow: hidden;
        }

        /* --- 區域 1：筆順分解區 (右側) --- */
        #stroke-area {
            height: 100%;
            display: flex;
            flex-direction: column; 
            flex-wrap: wrap;       
            direction: rtl; 
            align-content: flex-start; 
        }

        /* --- 區域 2：練習格區 (左側) --- */
        #practice-area {
            flex-grow: 1; 
            height: 100%;
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            align-content: flex-start;
            direction: rtl; 
            gap: 2px; 
        }

        /* --- 格子通用樣式 --- */
        .grid-box {
            border: 1px solid #000; 
            position: relative;
            background-color: white;
            box-sizing: border-box;
            direction: ltr; 
        }

        /* --- 米字格背景 (螢幕顯示用) --- */
        .grid-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .grid-bg::before { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; border-top: 1px dashed #ccc; }
        .grid-bg::after { content: ''; position: absolute; left: 50%; top: 0; width: 1px; height: 100%; border-left: 1px dashed #ccc; }
        
        .grid-bg-diagonal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            background: linear-gradient(to top right, transparent calc(50% - 0.5px), #eee calc(50% - 0.5px), #eee calc(50% + 0.5px), transparent calc(50% + 0.5px)),
                        linear-gradient(to bottom right, transparent calc(50% - 0.5px), #eee calc(50% - 0.5px), #eee calc(50% + 0.5px), transparent calc(50% + 0.5px));
        }

        svg.raw-svg { width: 100%; height: 100%; padding: 3px; box-sizing: border-box; }

        /* ========================================= */
        /* --- 列印專用設定 --- */
        /* ========================================= */
        @media print {
            @page { size: A4 portrait; margin: 0; }
            html, body { width: 210mm; height: 297mm; margin: 0; padding: 0; background: none; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .controls { display: none; }

            .page {
                width: 210mm !important; height: 296mm !important; margin: 0 !important; padding: 10mm !important;
                box-shadow: none; border: none;
                display: flex !important; flex-direction: row-reverse !important; flex-wrap: nowrap !important;
                align-items: flex-start; overflow: hidden;
            }
            #stroke-area, #practice-area { height: 100% !important; flex-shrink: 0; }
            svg { display: block; overflow: visible; }

            /* 斜線 X 顏色修正 (實體線) */
            .grid-bg-diagonal { background: none !important; }
            .grid-bg-diagonal::before, .grid-bg-diagonal::after {
                content: ''; position: absolute; top: 50%; left: 50%; width: 142%; height: 1px;
                background-color: #ccc !important; z-index: -1;
                -webkit-print-color-adjust: exact; print-color-adjust: exact;
            }
            .grid-bg-diagonal::before { transform: translate(-50%, -50%) rotate(45deg); }
            .grid-bg-diagonal::after { transform: translate(-50%, -50%) rotate(-45deg); }
            .grid-bg::before { border-top-color: #ccc !important; }
            .grid-bg::after { border-left-color: #ccc !important; }
        }
    </style>
</head>
<body>

    <div class="controls">
        <h2>直式生字練習簿</h2>
        <div class="control-group">
            <label>生字：<input type="text" id="charInput" value="蘇" maxlength="1"></label>
            <button onclick="startGenerate()">重新生成</button>
            <button class="print-btn" onclick="window.print()">列印 (A4)</button>
        </div>
        
        <div class="control-group" style="border-top: 1px solid #eee; padding-top:20px;">
            <label>格子大小：</label>
            
            <input type="range" id="sizeSlider" min="0" max="3" value="2" step="1" oninput="updateSizeDisplay()">
            
            <span id="sizeLabel" style="font-weight:bold; color:#d32f2f; font-size: 1.2rem; margin-left: 10px; width: 150px; text-align: left;">小 (120 px)</span>
        </div>
    </div>

    <div class="page">
        <div id="stroke-area"></div>
        <div id="practice-area"></div>
    </div>

    <script>
        // 定義四個尺寸的設定
        const SIZE_SETTINGS = [
            { label: '小', size: 120 },
            { label: '中', size: 135 },
            { label: '大', size: 160 },
            { label: '特大', size: 190 }
        ];

        window.onload = () => {
            updateSizeDisplay(); // 初始化顯示
        };

        // 當滑動時觸發，更新文字並生成
        function updateSizeDisplay() {
            const index = document.getElementById('sizeSlider').value;
            const setting = SIZE_SETTINGS[index];
            
            // 更新文字顯示
            document.getElementById('sizeLabel').textContent = `${setting.label} (${setting.size} px)`;
            
            // 執行生成
            startGenerate();
        }

        async function startGenerate() {
            const inputChar = document.getElementById('charInput').value.trim();
            // 根據滑桿的位置 (0~3)，去陣列裡拿真正的像素大小
            const sliderIndex = document.getElementById('sizeSlider').value;
            const userPracticeSize = SIZE_SETTINGS[sliderIndex].size;
            
            if (!inputChar) return;

            const strokeArea = document.getElementById('stroke-area');
            const practiceArea = document.getElementById('practice-area');
            strokeArea.innerHTML = '';
            practiceArea.innerHTML = '';

            try {
                const charData = await HanziWriter.loadCharacterData(inputChar);
                const totalStrokes = charData.strokes.length;

                // 計算筆順區
                const itemsPerCol = Math.ceil(totalStrokes / 2);
                const pageContentHeight = document.querySelector('.page').clientHeight - (30 * 3.78);
                let strokeGridSize = Math.floor(pageContentHeight / itemsPerCol) - 4;
                
                // 限制筆順格最大寬度
                if (strokeGridSize > 100) strokeGridSize = 100;
                if (strokeGridSize < 40) strokeGridSize = 40;

                strokeArea.style.width = (strokeGridSize * 2 + 10) + 'px'; 
                const GAP = 2;
                strokeArea.style.height = (itemsPerCol * (strokeGridSize + GAP)) + 'px'; 
                strokeArea.style.gap = GAP + 'px';

                charData.strokes.forEach((stroke, index) => {
                    const div = createGridBox(strokeGridSize);
                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    svg.classList.add('raw-svg');
                    svg.setAttribute('viewBox', '0 0 1024 1024');
                    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    g.setAttribute('transform', 'scale(1, -1) translate(0, -900)');

                    for (let k = 0; k <= index; k++) {
                        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        path.setAttribute('d', charData.strokes[k]);
                        path.setAttribute('fill', k === index ? '#FF0000' : '#BBBBBB'); 
                        g.appendChild(path);
                    }
                    svg.appendChild(g);
                    div.appendChild(svg);
                    strokeArea.appendChild(div);
                });

                // 計算練習格區 (稍微延遲確保 DOM 更新)
                setTimeout(() => {
                    const remainingWidth = practiceArea.clientWidth;
                    const fullHeight = document.querySelector('.page').clientHeight - (30 * 3.78);

                    const boxesPerColumn = Math.floor(fullHeight / (userPracticeSize + 4)); 
                    const numberOfColumns = Math.floor(remainingWidth / (userPracticeSize + 4));
                    const totalPracticeBoxes = boxesPerColumn * numberOfColumns;

                    for (let i = 0; i < totalPracticeBoxes; i++) {
                        let div = createGridBox(userPracticeSize);
                        div.id = `p-${i}`;
                        practiceArea.appendChild(div);

                        HanziWriter.create(div, inputChar, {
                            width: userPracticeSize,
                            height: userPracticeSize,
                            padding: 5,
                            strokeColor: '#DDDDDD', 
                            showOutline: false
                        });
                    }
                }, 50); // 時間縮短一點讓反應更靈敏

            } catch (err) {
                console.error(err);
                // 靜默失敗或顯示錯誤
            }
        }

        function createGridBox(size) {
            let div = document.createElement('div');
            div.className = 'grid-box';
            div.style.width = size + 'px';
            div.style.height = size + 'px';
            div.innerHTML = '<div class="grid-bg"></div><div class="grid-bg-diagonal"></div>';
            return div;
        }
    </script>
</body>
</html>