<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>直式生字練習簿</title>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <style>
        /* --- 基礎設定 --- */
        body { 
            font-family: "標楷體", "KaiTi", serif; 
            margin: 0; padding: 20px; 
            background-color: #555; /* 背景改深色，凸顯 A4 紙張 */
            display: flex; flex-direction: column; align-items: center;
        }

        /* --- 控制面板 --- */
        .controls { 
            background: white; padding: 20px; border-radius: 8px; 
            margin-bottom: 20px; text-align: center; width: 100%; max-width: 800px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .control-group { margin: 10px 0; display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; }
        
        input[type="text"] { padding: 8px; font-size: 1.5rem; width: 80px; text-align: center; border: 2px solid #4CAF50; border-radius: 5px;}
        input[type="range"] { vertical-align: middle; width: 200px; cursor: pointer; }
        
        button { 
            padding: 10px 25px; font-size: 1.1rem; cursor: pointer; 
            background-color: #4CAF50; color: white; border: none; border-radius: 4px;
            font-weight: bold;
        }
        button:hover { background-color: #45a049; }
        button.print-btn { background-color: #2196F3; }
        button.print-btn:hover { background-color: #0b7dda; }

        /* --- A4 紙張模擬 --- */
        .page {
            width: 210mm; 
            height: 296mm; /* 標準 A4 高度 */
            background: white;
            padding: 15mm; /* 邊距 */
            box-sizing: border-box;
            
            /* 關鍵佈局：讓整個版面分為左右兩區 */
            display: flex;
            flex-direction: row-reverse; /* 右邊是筆順區，左邊是練習區 */
            gap: 5mm;
            overflow: hidden;
        }

        /* --- 區域 1：筆順分解區 (右側) --- */
        #stroke-area {
            /* 這裡由 JS 動態計算寬度 */
            height: 100%;
            
            /* 【關鍵修正】讓格子呈現直書排列：從右上開始，往下排，排滿往左換行 */
            display: flex;
            flex-direction: column; 
            flex-wrap: wrap;       
            direction: rtl; /* 這是讓 Columns 由右向左堆疊的關鍵！ */
            
            align-content: flex-start; /* 內容靠右對齊 (因為 rtl) */
        }

        /* --- 區域 2：練習格區 (左側) --- */
        #practice-area {
            flex-grow: 1; /* 佔滿剩餘空間 */
            height: 100%;
            
            /* 練習格也是由上往下，滿了往左換行 */
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            align-content: flex-start; /* 靠右對齊 (向筆順區靠攏) */
            direction: rtl; /* 統一方向習慣 */
            
            gap: 2px; /* 格子稍微緊密一點 */
        }

        /* --- 格子通用樣式 --- */
        .grid-box {
            border: 1px solid #000;
            position: relative;
            background-color: white;
            box-sizing: border-box;
            /* 強制讓內容物(SVG)不被 rtl 影響方向，保持正向 */
            direction: ltr; 
        }

        /* 米字格背景 */
        .grid-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .grid-bg::before { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; border-top: 1px dashed #ccc; }
        .grid-bg::after { content: ''; position: absolute; left: 50%; top: 0; width: 1px; height: 100%; border-left: 1px dashed #ccc; }
        .grid-bg-diagonal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            background: linear-gradient(to top right, transparent calc(50% - 0.5px), #eee calc(50% - 0.5px), #eee calc(50% + 0.5px), transparent calc(50% + 0.5px)),
                        linear-gradient(to bottom right, transparent calc(50% - 0.5px), #eee calc(50% - 0.5px), #eee calc(50% + 0.5px), transparent calc(50% + 0.5px));
        }

        /* SVG 調整 */
        svg.raw-svg { width: 100%; height: 100%; padding: 3px; box-sizing: border-box; }

/* --- 列印專用 (強力修正版) --- */
        @media print {
            /* 1. 設定紙張為 A4，並移除預設邊距 */
            @page {
                size: A4 portrait; /* 直向 A4 */
                margin: 0;         /* 移除瀏覽器預設頁首頁尾 */
            }

            html, body {
                width: 210mm;
                height: 297mm;
                margin: 0;
                padding: 0;
                background: none;
                /* 強制列印顏色 (Chrome/Edge/Safari) */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .controls { display: none; } /* 隱藏控制面板 */

            /* 2. 針對 .page 進行強制排版鎖定 */
            .page {
                width: 210mm !important;
                height: 296mm !important; /* 留 1mm 緩衝防止溢出 */
                margin: 0 !important;
                padding: 10mm !important; /* 保持內距 */
                box-shadow: none;
                border: none;
                
                /* 關鍵修復：強制 Flex 不換行，保持左右排列 */
                display: flex !important;
                flex-direction: row-reverse !important; /* 維持右至左 */
                flex-wrap: nowrap !important; /* 【絕對禁止換行】 */
                align-items: flex-start;
                
                overflow: hidden; /* 超出範圍直接切掉，避免變形 */
            }

            /* 3. 確保左右兩區的高度正確 */
            #stroke-area, #practice-area {
                height: 100% !important;
                /* 確保不會因為列印縮放而被擠壓 */
                flex-shrink: 0; 
            }
            
            /* 4. 強制顯示背景線條與 SVG */
            .grid-bg, .grid-bg-diagonal {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            svg {
                display: block;
                overflow: visible;
            }
        }
    </style>
</head>
<body>

    <div class="controls">
        <h2>直式生字練習簿</h2>
        <div class="control-group">
            <label>生字：<input type="text" id="charInput" value="蘇" maxlength="1"></label>
            <button onclick="startGenerate()">生成</button>
            <button class="print-btn" onclick="window.print()">列印 (A4)</button>
        </div>
        <div class="control-group" style="border-top: 1px solid #eee; padding-top:10px;">
            <label>練習格大小：<span id="sizeValue" style="font-weight:bold; color:#d32f2f;">120</span> px</label>
            <input type="range" id="gridSizeInput" min="80" max="180" value="120" step="5" oninput="updateSizeLabel(this.value)">
        </div>
    </div>

    <div class="page">
        <div id="stroke-area"></div>
        <div id="practice-area"></div>
    </div>

    <script>
        window.onload = () => startGenerate();

        function updateSizeLabel(val) {
            document.getElementById('sizeValue').textContent = val;
        }

        async function startGenerate() {
            const inputChar = document.getElementById('charInput').value.trim();
            const userPracticeSize = parseInt(document.getElementById('gridSizeInput').value); 
            
            if (!inputChar) return;

            const strokeArea = document.getElementById('stroke-area');
            const practiceArea = document.getElementById('practice-area');
            strokeArea.innerHTML = '';
            practiceArea.innerHTML = '';

            try {
                // 1. 取得筆劃數據
                const charData = await HanziWriter.loadCharacterData(inputChar);
                const totalStrokes = charData.strokes.length;

                // 2. 計算筆順區 (固定 2 行)
                const itemsPerCol = Math.ceil(totalStrokes / 2); // 一行要放幾個
                
                // 取得頁面內容的可用高度
                const pageContentHeight = document.querySelector('.page').clientHeight - (30 * 3.78); // 減去 padding 緩衝
                
                // 計算筆順格最佳高度
                let strokeGridSize = Math.floor(pageContentHeight / itemsPerCol) - 4; // -4 for gap/border
                
                // 限制大小 (太大很怪，太小看不到)
                if (strokeGridSize > 100) strokeGridSize = 100;
                if (strokeGridSize < 40) strokeGridSize = 40;

                // 設定筆順區寬度：大小 * 2行 (加上間距緩衝)
                strokeArea.style.width = (strokeGridSize * 2 + 10) + 'px'; 
                // 設定 gap
                strokeArea.style.gap = '2px';

                // 生成筆順分解 (紅/灰)
                charData.strokes.forEach((stroke, index) => {
                    const div = createGridBox(strokeGridSize);
                    
                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    svg.classList.add('raw-svg');
                    svg.setAttribute('viewBox', '0 0 1024 1024');
                    
                    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    g.setAttribute('transform', 'scale(1, -1) translate(0, -900)');

                    for (let k = 0; k <= index; k++) {
                        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        path.setAttribute('d', charData.strokes[k]);
                        // 紅色只有當前這一筆，其他灰色
                        path.setAttribute('fill', k === index ? '#FF0000' : '#BBBBBB'); 
                        g.appendChild(path);
                    }
                    svg.appendChild(g);
                    div.appendChild(svg);
                    strokeArea.appendChild(div);
                });


                // 3. 計算練習格區 (自動填滿)
                setTimeout(() => {
                    const remainingWidth = practiceArea.clientWidth;
                    const remainingHeight = practiceArea.clientHeight;

                    // 因為我們現在是 direction: rtl + flex column
                    // 所以 Rows 是直的 (Height / Size)，Cols 是橫的 (Width / Size)
                    const boxesPerColumn = Math.floor(remainingHeight / (userPracticeSize + 4)); 
                    const numberOfColumns = Math.floor(remainingWidth / (userPracticeSize + 4));

                    const totalPracticeBoxes = boxesPerColumn * numberOfColumns;

                    for (let i = 0; i < totalPracticeBoxes; i++) {
                        let div = createGridBox(userPracticeSize);
                        div.id = `p-${i}`;
                        practiceArea.appendChild(div);

                        HanziWriter.create(div, inputChar, {
                            width: userPracticeSize,
                            height: userPracticeSize,
                            padding: 5,
                            strokeColor: '#DDDDDD', // 淺灰
                            showOutline: false
                        });
                    }
                }, 100);

            } catch (err) {
                console.error(err);
                alert("找不到這個字，請確認輸入正確。");
            }
        }

        function createGridBox(size) {
            let div = document.createElement('div');
            div.className = 'grid-box';
            div.style.width = size + 'px';
            div.style.height = size + 'px';
            div.innerHTML = '<div class="grid-bg"></div><div class="grid-bg-diagonal"></div>';
            return div;
        }
    </script>
</body>
</html>